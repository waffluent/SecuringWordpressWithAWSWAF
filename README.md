# Securing Wordpress With AWS WAF(v2)

---

# AWS Lambda Origin-Hiding with CloudFront Managed Prefix List

This Terraform module deploys a **secure AWS Lambda function** (usable as Lambda\@Edge for CloudFront or as a Regional Lambda for ALB/API Gateway) that generates a signed header (`x-aws-pass`) for origin-hiding and request authentication.

The Lambda:

* Uses a **shared HMAC secret** to sign requests
* In **CloudFront mode**:

  * Confirms execution in Lambda\@Edge context
  * Validates source IP against AWS’s **CloudFront origin-facing Managed Prefix List (MPL)**
  * Uses AWS-generated `requestId` as the nonce (non-spoofable)
* In **Regional mode**:

  * Skips MPL check
  * Generates a random nonce in AWS

The module dynamically retrieves the latest **CloudFront MPL CIDRs** at deploy time, so no manual IP maintenance is required.

---

## **Files Overview**

### **Terraform**

1. **`vars.tf`** – Defines all module input variables.
2. **`data.tf`** – Retrieves AWS-managed CloudFront MPL CIDRs at deploy time.
3. **`main.tf`** – Creates Lambda, injects MPL CIDRs and HMAC secret as environment variables, grants CloudFront invoke permissions.
4. **`outputs.tf`** – Exposes Lambda name, ARN, MPL ID, and MPL CIDRs.
5. **`aws-lambda-edge-origin-hiding.js`** – Lambda code that:

   * CloudFront mode: MPL IP check + AWS `requestId` nonce
   * Regional mode: random nonce
   * Generates signed `x-aws-pass` header

---

## **WordPress Verification Plugin**

A lightweight MU-plugin for WordPress is provided (`verify-origin-hiding.php`) to verify the `x-aws-pass` header generated by the Lambda.

### **Purpose**

* Ensures every request to WordPress has:

  * A valid IP address (`REMOTE_ADDR`)
  * A valid `x-aws-pass` header in `<hmac>.<timestamp>.<nonce>` format
  * A timestamp no older than 5 minutes
  * An HMAC that matches the Lambda’s signing logic

### **Requirements**

* Must use the same `shared_secret` as the Terraform Lambda configuration.
* Must be installed as a **MU-plugin** so it runs before normal request handling.

### **Installation**

1. Save `verify-origin-hiding.php` to:

   ```
   wp-content/mu-plugins/verify-origin-hiding.php
   ```
2. Edit the file and set:

   ```php
   $secret = 'your-secret-string-here';
   ```

   to match the `shared_secret` from your Terraform deployment.
3. Deploy and test:

   * Requests without the header → blocked with HTTP 403
   * Requests with expired or invalid signatures → blocked
   * Requests with valid signatures → allowed

---

## **Usage Example: Terraform Module**

```hcl
module "origin_hiding_lambda" {
  source          = "./modules/aws-lambda-origin-hiding"
  lambda_name     = "origin-hiding-signer"
  lambda_runtime  = "nodejs20.x"
  lambda_filename = "${path.module}/lambda.zip"
  lambda_role_arn = aws_iam_role.lambda_execution.arn
  shared_secret   = var.shared_secret
  deploy_region   = "us-east-1" # For Lambda@Edge
}
```

---

## **Security Flow – CloudFront Mode**

| Step | Actor        | Action                                                                            | Purpose                                                        |
| ---- | ------------ | --------------------------------------------------------------------------------- | -------------------------------------------------------------- |
| 1    | Client       | Sends request for content to CloudFront.                                          | User initiates request.                                        |
| 2    | CloudFront   | Invokes Lambda\@Edge on `viewer-response` or `origin-request` event.              | Allow Lambda to sign the request.                              |
| 3    | Lambda\@Edge | Validates source IP against CloudFront MPL CIDRs. Uses AWS `requestId` as nonce.  | Confirms request came from CloudFront; nonce is non-spoofable. |
| 4    | Lambda\@Edge | Generates `x-aws-pass` header containing HMAC, timestamp, and nonce.              | Creates cryptographic proof of valid edge handling.            |
| 5    | CloudFront   | Forwards request with `x-aws-pass` to WAF.                                        | Passes signed request to security layer.                       |
| 6    | WAF          | (Optional) Checks that `x-aws-pass` header exists and matches expected format.    | Blocks obvious invalid/missing headers before origin.          |
| 7    | CloudFront   | Sends request to WordPress origin.                                                | Delivers signed request to origin.                             |
| 8    | WordPress    | Verifies: valid IP, correct header format, timestamp freshness, and correct HMAC. | Confirms authenticity before processing request.               |
| 9    | WordPress    | Returns response to client.                                                       | Sends legitimate content to user.                              |

---

## **Security Flow – Regional Mode**

| Step | Actor       | Action                                                                            | Purpose                                               |
| ---- | ----------- | --------------------------------------------------------------------------------- | ----------------------------------------------------- |
| 1    | Client      | Sends request directly to Regional service (ALB/API Gateway).                     | User initiates request.                               |
| 2    | Lambda      | Generates random nonce, creates `x-aws-pass` header with HMAC and timestamp.      | Adds signature without MPL check.                     |
| 3    | Lambda      | Sends request with `x-aws-pass` to WAF.                                           | Passes signed request to security layer.              |
| 4    | WAF         | (Optional) Checks that `x-aws-pass` header exists and matches expected format.    | Blocks obvious invalid/missing headers before origin. |
| 5    | Service/ALB | Sends request to WordPress origin.                                                | Delivers signed request to origin.                    |
| 6    | WordPress   | Verifies: valid IP, correct header format, timestamp freshness, and correct HMAC. | Confirms authenticity before processing request.      |
| 7    | WordPress   | Returns response to client.                                                       | Sends legitimate content to user.                     |

